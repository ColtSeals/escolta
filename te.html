<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Processador de Escolta/Preservação</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .table-container {
            max-height: 400px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h2 class="mb-3">Processador de Dados de Escolta/Preservação</h2>
        
        <div class="row">
            <div class="col-md-6">
                <div class="mb-3">
                    <label for="inputText" class="form-label">Cole o texto aqui:</label>
                    <textarea class="form-control" id="inputText" rows="10" placeholder="Cole o texto aqui..."></textarea>
                </div>
                <button class="btn btn-primary mb-3" onclick="processText()">Processar Texto</button>
            </div>
            <div class="col-md-6">
                <div class="table-container">
                    <table class="table table-striped table-bordered" id="outputTable">
                        <thead>
                            <tr>
                                <th>Modalidade</th>
                                <th>Empresa</th>
                                <th>Origem</th>
                                <th>Destino</th>
                                <th>Data</th>
                                <th>Horário</th>
                                <th>Motorista</th>
                                <th>Placa</th>
                                <th>Telefone</th>
                                <th>Agente</th>
                                <th>Telefone Agente</th>
                                <th>Veículo</th>
                                <th>Placa Veículo</th>
                                <th>Valor Pedágio</th>
                                <th>Km Inicial</th>
                                <th>Km Final</th>
                                <th>Total Km</th>
                                <th>Hora Local</th>
                                <th>Início Op.</th>
                                <th>Término Op.</th>
                                <th>Total Hrs Op.</th>
                                <th>Total Hrs Agente</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                <button class="btn btn-success mt-3" onclick="copyToClipboard()">Copiar para Excel</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function processText() {
            const text = document.getElementById('inputText').value;
            const lines = text.split('\n').filter(line => line.trim() !== '');
            const tableBody = document.querySelector('#outputTable tbody');
            tableBody.innerHTML = '';

            let currentData = {};
            let agentes = [];
            let telefonesAgente = [];
            let veiculos = [];
            let placasVeiculos = [];

            lines.forEach(line => {
                line = line.trim();

                // Início de nova entrada
                if (line.match(/^(ESCOLTA|PRESERVAÇÃO|ENVISION|SUPERSONIC)$/)) {
                    if (Object.keys(currentData).length > 0) {
                        processAgents(currentData, agentes, telefonesAgente, veiculos, placasVeiculos);
                    }
                    currentData = { Modalidade: line.split(' ')[0], Empresa: line.split(' ')[1] || '' };
                    agentes = [];
                    telefonesAgente = [];
                    veiculos = [];
                    placasVeiculos = [];
                }
                else if (line.startsWith('Origem:')) currentData.Origem = line.replace('Origem: ', '');
                else if (line.startsWith('Destino:')) currentData.Destino = line.replace('Destino: ', '');
                else if (line.startsWith('Data:')) currentData.Data = line.replace('Data: ', '');
                else if (line.startsWith('Hora:')) currentData.Horario = line.replace('Hora: ', '');
                else if (line.startsWith('Motorista:')) currentData.Motorista = line.replace('Motorista: ', '');
                else if (line.startsWith('Placa:') && !veiculos.length) currentData.Placa = line.replace('Placa: ', '');
                else if (line.startsWith('Telefone:') && !telefonesAgente.length) currentData.Telefone = line.replace('Telefone: ', '');
                else if (line.startsWith('Agente:')) {
                    agentes = line.replace('Agente: ', '').split(' e ');
                }
                else if (line.startsWith('Telefones do agente:') || (line.startsWith('Telefone:') && agentes.length)) {
                    telefonesAgente.push(line.replace(/Telefones do agente: |Telefone: /, ''));
                }
                else if (line.startsWith('Veículo utilizado:')) {
                    veiculos.push(line.replace('Veículo utilizado: ', ''));
                }
                else if (line.startsWith('Placa:') && veiculos.length) {
                    placasVeiculos.push(line.replace('Placa: ', ''));
                }
                else if (line.startsWith('Valor do pedágio:')) currentData['Valor Pedágio'] = line.replace('Valor do pedágio: ', '');
                else if (line.startsWith('Km inicial:')) currentData['Km Inicial'] = parseInt(line.replace('Km inicial: ', '')) || 0;
                else if (line.startsWith('Km final:')) currentData['Km Final'] = parseInt(line.replace('Km final: ', '')) || 0;
                else if (line.startsWith('Total de km:')) currentData['Total Km'] = parseInt(line.replace('Total de km: ', '')) || 0;
                else if (line.startsWith('Horário local do agente:')) currentData['Hora Local'] = line.replace('Horário local do agente: ', '');
                else if (line.startsWith('Horário de início da operação:')) currentData['Início Op.'] = line.replace('Horário de início da operação: ', '');
                else if (line.startsWith('Horário de término da operação:')) currentData['Término Op.'] = line.replace('Horário de término da operação: ', '');
                else if (line.startsWith('Total de horas da operação:')) currentData['Total Hrs Op.'] = line.replace('Total de horas da operação: ', '');
                else if (line.startsWith('Total de horas do agente:')) currentData['Total Hrs Agente'] = line.replace('Total de horas do agente: ', '');
            });

            // Processar a última entrada
            if (Object.keys(currentData).length > 0) {
                processAgents(currentData, agentes, telefonesAgente, veiculos, placasVeiculos);
            }
        }

        function processAgents(data, agentes, telefonesAgente, veiculos, placasVeiculos) {
            if (agentes.length === 0) agentes.push(''); // Caso não haja agente

            agentes.forEach((agente, index) => {
                const rowData = { ...data };
                rowData.Agente = agente;
                rowData['Telefone Agente'] = telefonesAgente[index] || '';
                rowData.Veículo = veiculos[index] || '';
                rowData['Placa Veículo'] = placasVeiculos[index] || '';

                // Calcular Total Km automaticamente se não estiver preenchido
                if (!rowData['Total Km'] && rowData['Km Inicial'] && rowData['Km Final']) {
                    rowData['Total Km'] = rowData['Km Final'] - rowData['Km Inicial'];
                }

                addRowToTable(rowData);
            });
        }

        function addRowToTable(data) {
            const tableBody = document.querySelector('#outputTable tbody');
            const row = document.createElement('tr');

            const fields = [
                'Modalidade', 'Empresa', 'Origem', 'Destino', 'Data', 'Horario', 'Motorista', 'Placa', 'Telefone',
                'Agente', 'Telefone Agente', 'Veículo', 'Placa Veículo', 'Valor Pedágio', 'Km Inicial', 'Km Final',
                'Total Km', 'Hora Local', 'Início Op.', 'Término Op.', 'Total Hrs Op.', 'Total Hrs Agente'
            ];

            fields.forEach(field => {
                const cell = document.createElement('td');
                cell.textContent = data[field] || '';
                row.appendChild(cell);
            });

            tableBody.appendChild(row);
        }

        function copyToClipboard() {
            const table = document.getElementById('outputTable');
            let tsv = '';
            const rows = table.querySelectorAll('tr');
            
            rows.forEach(row => {
                const cells = row.querySelectorAll('th, td');
                const rowData = Array.from(cells).map(cell => cell.textContent).join('\t');
                tsv += rowData + '\n';
            });

            navigator.clipboard.writeText(tsv).then(() => {
                alert('Dados copiados para a área de transferência! Cole no Excel com Ctrl+V');
            });
        }
    </script>
</body>
</html>
